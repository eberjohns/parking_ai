<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoPark Navigation Demo</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; }
        #app-container { width: 100vw; height: 100vh; background: #202124; overflow: hidden; position: relative; }
        /* 3D tilt effect for the map */
        #map {
            position: absolute;
            top: -10vh; left: -10vw;
            width: 120vw; height: 120vh; z-index: 1;
            transform: perspective(1200px) rotateX(30deg) scale(1.08);
            box-shadow: 0 40px 80px rgba(0,0,0,0.5);
            border-radius: 0;
            transition: transform 0.3s;
        }
        /* 3D car marker shadow effect */
        .leaflet-marker-icon.car-3d {
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.7));
        }
        .hud { position: absolute; z-index: 3000; pointer-events: auto; }
        #top-bar { top: 48px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; color: white; display: flex; align-items: center; gap: 15px; }
        /* 3D car marker style */
        .custom-car-marker {
            width: 44px; height: 70px;
            background: linear-gradient(180deg, #4285f4 60%, #222 100%);
            border-radius: 14px 14px 18px 18px/18px 18px 30px 30px;
            box-shadow: 0 10px 24px 0 rgba(0,0,0,0.7);
            border: 3px solid #fff;
            position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .custom-car-marker::before {
            content: '';
            position: absolute;
            top: 8px; left: 50%;
            width: 18px; height: 18px;
            background: #fff;
            border-radius: 50%;
            transform: translateX(-50%);
            opacity: 0.18;
            filter: blur(2px);
        }
        .custom-car-marker::after {
            content: '';
            position: absolute;
            bottom: 0; left: 50%;
            width: 24px; height: 24px;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.2) 100%);
            border-radius: 50%;
            transform: translateX(-50%);
            filter: blur(2px);
        }
        .custom-car-headlight {
            position: absolute;
            top: 0; left: 50%;
            width: 10px; height: 24px;
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0) 100%);
            border-radius: 50%;
            transform: translateX(-50%);
            opacity: 0.7;
            filter: blur(2px);
        }
        #controls { bottom: 30px; right: 30px; pointer-events: auto; display: flex; gap: 10px; }
        .btn { background: #4285f4; color: white; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: #0f9d58; }
        #sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            border-radius: 20px 0 0 20px;
            transform: translateX(110%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 4000;
            box-shadow: -10px 0 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        #sidebar.active {
            transform: translateX(0);
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: start; }
        .sidebar-title h2 { margin: 0; font-size: 24px; color: #333; }
        .sidebar-title p { margin: 5px 0 0; color: #666; }
        .close-btn { background: #f1f3f4; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        #live-grid-container {
            flex: 1;
            position: relative;
            background: #f8f9fa;
            margin: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #live-map-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0.6;
            display: block;
        }
        .live-slot { position: absolute; background: rgba(46, 204, 113, 0.6); border: 1px solid white; transition: background 0.3s; }
        .live-slot.occupied { background: rgba(231, 76, 60, 0.8) !important; }
    </style>
</head>
<body>


<div id="app-container">
    <div id="map"></div>
    <div class="hud" id="top-bar">
        <span style="font-size: 24px; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: #fff; color: #4285f4; border-radius: 8px; font-weight: bold; box-shadow: 0 2px 8px rgba(66,133,244,0.15);">
            <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="22" height="22" rx="6" fill="#fff"/>
                <text x="11" y="16" text-anchor="middle" font-size="14" font-family="Segoe UI, Arial, sans-serif" fill="#4285f4" font-weight="bold">P</text>
            </svg>
        </span>
        <div>
            <div style="font-size: 12px; opacity: 0.8;">NEAREST PARKING</div>
            <div id="distance-display" style="font-weight: bold;">Searching...</div>
        </div>
    </div>
    <div class="hud" id="controls">
        <button class="btn" onclick="startAutoDrive()">Auto-Drive Demo</button>
        <button class="btn btn-green" onclick="findParking()">Find Spot</button>
    </div>
    <div id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <h2 id="sidebar-name">St. Thomas College</h2>
                <p id="sidebar-meta">Live Occupancy Feed • <span style="color:#0f9d58">Connecting...</span></p>
            </div>
            <button class="close-btn" onclick="closeSidebar()">×</button>
        </div>
        <div class="sidebar-details" style="padding: 0 20px 20px 20px; color: #444; font-size: 15px;">
            <b>Details:</b>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque euismod, urna eu tincidunt consectetur, nisi nisl aliquam nunc, eget aliquam massa nisl quis neque. Proin ac neque nec nisi blandit commodo.</p>
        </div>
        <div id="live-grid-container">
            <img id="live-map-img" src="st_thomas_top_down.png" alt="Live View">
            <div id="live-slots-layer"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // --- 1. CONFIGURATION ---
    const API_BASE_URL = "http://localhost:8000"; // Your Backend
    // Mock parking lots
    const PARKING_LOTS = [
        { id: 'lot_st_thomas', name: 'St. Thomas College', lat: 10.5222, lng: 76.2177 },
        { id: 'lot_jubilee', name: 'Jubilee Park', lat: 10.5230, lng: 76.2185 },
        { id: 'lot_city_mall', name: 'City Mall Parking', lat: 10.5210, lng: 76.2155 },
        { id: 'lot_bus_stand', name: 'Bus Stand Lot', lat: 10.5205, lng: 76.2170 },
        { id: 'lot_railway', name: 'Railway Parking', lat: 10.5240, lng: 76.2160 }
    ];
    const LOT_LOCATION = PARKING_LOTS[0];
    const CAR_START = { lat: 10.5215, lng: 76.2165 };
    let carMarker = null;
    let isAutoDriving = false;
    let carLatLng = { ...CAR_START };

    // --- 2. INIT LEAFLET MAP ---
    const map = L.map('map').setView([CAR_START.lat, CAR_START.lng], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // --- 3. ADD PARKING MARKER ---
    // Custom Parking SVG Icon
    const ParkingDivIcon = L.divIcon({
        className: '',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        html: `
            <div style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="15" fill="#fff" stroke="#4285f4" stroke-width="2"/>
                    <text x="16" y="22" text-anchor="middle" font-size="18" font-family="Segoe UI, Arial, sans-serif" fill="#4285f4" font-weight="bold">P</text>
                </svg>
            </div>
        `
    });
    // Add all parking lot markers
    PARKING_LOTS.forEach(lot => {
        L.marker([lot.lat, lot.lng], {
            icon: ParkingDivIcon,
            title: lot.name
        })
        .addTo(map)
        .bindPopup(`<b>${lot.name}</b><br>Parking Lot`)
        .on('click', () => openSidebar(lot.id));
    });

    // --- 4. ADD CAR MARKER ---
    // Custom HTML marker for 3D car effect
    let carAngle = 0;
    const CarDivIcon = L.divIcon({
        className: '',
        iconSize: [44, 70],
        iconAnchor: [22, 35],
            // html: `<div class="custom-car-marker" style="width:44px;height:70px;display:flex;align-items:center;justify-content:center;">
            //     <img src="./car.png" alt="Car" style="width:38px;height:60px;object-fit:contain;display:block;" />
            // </div>`
            html: `<div class="custom-car-marker" style="width:44px;height:70px;display:flex;align-items:center;justify-content:center;">
            </div>`
    });
    carMarker = L.marker([CAR_START.lat, CAR_START.lng], {
        icon: CarDivIcon,
        title: 'Your Car',
        draggable: false
    }).addTo(map);

    // --- 5. DISTANCE DISPLAY ---
    function updateDistanceDisplay() {
        const dist = map.distance([carLatLng.lat, carLatLng.lng], [LOT_LOCATION.lat, LOT_LOCATION.lng]);
        document.getElementById('distance-display').innerText = Math.round(dist) + 'm away';
    }
    updateDistanceDisplay();

    // --- 6. CAR MOVEMENT (ARROW KEYS) ---
    let keys = {};
    function moveCar() {
        let moved = false;
        let dLat = 0, dLng = 0;
        const step = 0.000012; // ~1.2m per keypress, slower
        if (keys['ArrowUp'])    { dLat += step; moved = true; carAngle = 0; }
        if (keys['ArrowDown'])  { dLat -= step; moved = true; carAngle = 180; }
        if (keys['ArrowLeft'])  { dLng -= step; moved = true; carAngle = 270; }
        if (keys['ArrowRight']) { dLng += step; moved = true; carAngle = 90; }
        // Diagonal movement angle
        if (keys['ArrowUp'] && keys['ArrowLeft']) carAngle = 315;
        if (keys['ArrowUp'] && keys['ArrowRight']) carAngle = 45;
        if (keys['ArrowDown'] && keys['ArrowLeft']) carAngle = 225;
        if (keys['ArrowDown'] && keys['ArrowRight']) carAngle = 135;
        if (moved) {
            carLatLng.lat += dLat;
            carLatLng.lng += dLng;
            carMarker.setLatLng([carLatLng.lat, carLatLng.lng]);
            // Rotate only the inner car div, not the marker container
            const carEl = carMarker.getElement();
            if (carEl) {
                const carBody = carEl.querySelector('.custom-car-marker');
                if (carBody) carBody.style.transform = `rotate(${carAngle}deg)`;
            }
            map.panTo([carLatLng.lat, carLatLng.lng]);
            updateDistanceDisplay();
        }
        requestAnimationFrame(moveCar);
    }
    window.addEventListener('keydown', e => { keys[e.code] = true; });
    window.addEventListener('keyup', e => { keys[e.code] = false; });
    requestAnimationFrame(moveCar);

    // --- 7. AUTO DRIVE FEATURE ---
    function startAutoDrive() {
        isAutoDriving = true;
        const target = [LOT_LOCATION.lat, LOT_LOCATION.lng];
        const interval = setInterval(() => {
            const dist = map.distance([carLatLng.lat, carLatLng.lng], target);
            if (dist < 10) {
                clearInterval(interval);
                isAutoDriving = false;
                openSidebar('lot_st_thomas');
                return;
            }
            // Move car towards target
            const dLat = (target[0] - carLatLng.lat) * 0.08;
            const dLng = (target[1] - carLatLng.lng) * 0.08;
            carLatLng.lat += dLat;
            carLatLng.lng += dLng;
            // Calculate angle
            carAngle = Math.atan2(dLng, dLat) * 180 / Math.PI;
            carMarker.setLatLng([carLatLng.lat, carLatLng.lng]);
            const carEl = carMarker.getElement();
            if (carEl) {
                const carBody = carEl.querySelector('.custom-car-marker');
                if (carBody) carBody.style.transform = `rotate(${carAngle}deg)`;
            }
            map.panTo([carLatLng.lat, carLatLng.lng]);
            updateDistanceDisplay();
        }, 16);
    }

    function findParking() {
        // Calculate distances to all lots
        const lotsWithDistance = PARKING_LOTS.map(lot => ({
            ...lot,
            distance: map.distance([carLatLng.lat, carLatLng.lng], [lot.lat, lot.lng])
        }));
        lotsWithDistance.sort((a, b) => a.distance - b.distance);
        // Show list in sidebar
        let html = `<div style='padding:20px'><h3>Nearby Parking Lots</h3><ul style='list-style:none;padding:0;'>`;
        lotsWithDistance.forEach(lot => {
            html += `<li style='margin-bottom:12px;'><b>${lot.name}</b><br><span style='color:#4285f4'>${Math.round(lot.distance)}m away</span> <button onclick="window.selectLot('${lot.id}')" style='margin-left:10px;padding:4px 10px;border-radius:6px;border:none;background:#4285f4;color:#fff;cursor:pointer;'>Select</button></li>`;
        });
        html += `</ul></div>`;
        document.getElementById('sidebar').classList.add('active');
        document.getElementById('sidebar').innerHTML = html;
        // Helper for selecting lot
        window.selectLot = function(lotId) {
            const lot = PARKING_LOTS.find(l => l.id === lotId);
            if (!lot) return;
            map.panTo([lot.lat, lot.lng]);
            // Optionally, draw a line from car to selected lot
            if (window.routeLine) map.removeLayer(window.routeLine);
            window.routeLine = L.polyline([
                [carLatLng.lat, carLatLng.lng],
                [lot.lat, lot.lng]
            ], { color: '#4285f4', weight: 4, dashArray: '8 8' }).addTo(map);
        };
    }

    // --- 8. SIDEBAR & LIVE FEED (unchanged) ---
    let pollingInterval = null;
    let cachedConfig = [];
    async function openSidebar(lotId) {
        document.getElementById('sidebar').classList.add('active');
        try {
            const res = await fetch(`${API_BASE_URL}/api/config`);
            const config = await res.json();
            cachedConfig = config.slots;
            startLivePolling();
        } catch (e) {
            console.error("Backend Error", e);
            document.getElementById('sidebar-meta').innerText = "Backend Offline - Check Server";
            document.getElementById('sidebar-meta').style.color = "red";
        }
    }
    function closeSidebar() {
        document.getElementById('sidebar').classList.remove('active');
        if (pollingInterval) clearInterval(pollingInterval);
    }
    function startLivePolling() {
        pollingInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE_URL}/api/status`);
                const data = await res.json();
                renderLiveGrid(data.status_string);
                const occupied = (data.status_string.match(/1|C|S|B/g) || []).length;
                const free = data.status_string.length - occupied;
                document.getElementById('sidebar-meta').innerHTML = `Live Feed • <span style="color:#0f9d58"><b>${free}</b> Slots Available</span>`;
            } catch (e) { console.warn("Poll failed"); }
        }, 1000);
    }
    function renderLiveGrid(statusString) {
        const layer = document.getElementById('live-slots-layer');
        layer.innerHTML = '';
        const originalW = 800;
        const containerW = document.getElementById('live-grid-container').offsetWidth;
        const scale = containerW / originalW;
        cachedConfig.forEach((slot, index) => {
            const state = statusString[index] || '0';
            const div = document.createElement('div');
            div.className = 'live-slot';
            if (state !== '0') div.classList.add('occupied');
            const coords = slot.coordinates || slot;
            div.style.left = (coords.x * scale) + 'px';
            div.style.top = (coords.y * scale) + 'px';
            div.style.width = (coords.w * scale) + 'px';
            div.style.height = (coords.h * scale) + 'px';
            layer.appendChild(div);
        });
    }
</script>

</body>
</html>